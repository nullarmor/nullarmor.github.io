<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>nullarmor | Granny - Hack The Box</title>
  <meta name="description" content="Resolution of the Granny machine">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Granny - Hack The Box">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://nullarmor.github.io/posts/granny">
  <meta property="og:description" content="Resolution of the Granny machine">
  <meta property="og:site_name" content="nullarmor">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="https://nullarmor.github.io/posts/granny">
  <meta name="twitter:title" content="Granny - Hack The Box">
  <meta name="twitter:description" content="Resolution of the Granny machine">
  <meta name="google-site-verification" content="1sfOj2zDu7c444806MBQqbqFzNWxik880zgryQLMj-o" />

  
    
      <meta property="og:image" content="https://nullarmor.github.io/assets/hackthebox/granny/granny-00-6c3e1b977b29846088be13d14a6e91cb80dbfad49560c32e08d613883c43d1f3.png">
      <meta name="twitter:image" content="https://nullarmor.github.io/assets/hackthebox/granny/granny-00-6c3e1b977b29846088be13d14a6e91cb80dbfad49560c32e08d613883c43d1f3.png">
    
  

  <link href="https://nullarmor.github.io/feed.xml" type="application/rss+xml" rel="alternate" title="nullarmor Last 10 blog posts" />

  

  

    
      <link rel="icon" type="image/x-icon" href="/assets/favicon-5df081ea197cddd592e345971da85e359e2f613dae2506c368835a695a297f82.gif">
      <link rel="apple-touch-icon" href="/assets/favicon-5df081ea197cddd592e345971da85e359e2f613dae2506c368835a695a297f82.gif">
      <link rel="stylesheet" type="text/css" title="light" id="light" href="/assets/light-fd3e34295723b96a04f635903b3650e5bb101ebdcc4d959165c3b4d2d88abe5e.css">
      <link rel="stylesheet" type="text/css" title="dark" id="dark" href="/assets/dark-0f2545b8bdef934d32dd563b17074c614e7f4f4d5c3e682d4089a07fed36aa84.css" disabled="false">
    

  

</head>

<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav scrollappear">
  <a href="/" class="header-logo" title="nullarmor">nullarmor</a>
  <ul class="header-links">
    
      <li>
        <a href="/about" title="About me">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-about">
  <use href="/assets/about-ecf154b571ab8034ae00aeed91a3b7ad68db80b46d958753ad6216c919486e88.svg#icon-about" xlink:href="/assets/about-ecf154b571ab8034ae00aeed91a3b7ad68db80b46d958753ad6216c919486e88.svg#icon-about"></use>
</svg>

        </a>
      </li>
    
    
      <li>
        <a href="https://twitter.com/nullarmor" rel="noreferrer noopener" target="_blank" title="Twitter">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-twitter">
  <use href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter" xlink:href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter"></use>
</svg>

        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://github.com/nullarmor" rel="noreferrer noopener" target="_blank" title="GitHub">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-github">
  <use href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github" xlink:href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github"></use>
</svg>

        </a>
      </li>
    
    
    
    
    
    
    
      <li>
        <a href="https://www.linkedin.com/in/renan-almeida-8137a81a6" rel="noreferrer noopener" target="_blank" title="LinkedIn">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-linkedin">
  <use href="/assets/linkedin-cdc5c107044324a3dfbea2e9ead15873f8dee304c37d73a046988956b706256e.svg#icon-linkedin" xlink:href="/assets/linkedin-cdc5c107044324a3dfbea2e9ead15873f8dee304c37d73a046988956b706256e.svg#icon-linkedin"></use>
</svg>

        </a>
      </li>
    
    
    
    
    
    
    
    
    
    
    
    
    
      <li>
        <a href="mailto:nullarmor@protonmail.com" title="Email">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-email">
  <use href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email" xlink:href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email"></use>
</svg>

        </a>
      </li>
    
    
    
      <li>
        <a onclick="toggle()" title="Toggle Theme">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-theme">
  <use href="/assets/theme-66869e0bf8dab34bae1c86bda400327b772e0be69e8dc28d3ede896e771320ed.svg#icon-theme" xlink:href="/assets/theme-66869e0bf8dab34bae1c86bda400327b772e0be69e8dc28d3ede896e771320ed.svg#icon-theme"></use>
</svg>

        </a>
      </li>
    
  </ul>
</nav>


  <ul class="header-tags scrollappear">
    
    
      
        <li><a href="/tag/ctf">Ctf</a></li>
    
      
        <li><a href="/tag/cybrics">Cybrics</a></li>
    
      
        <li><a href="/tag/hackthebox">Hackthebox</a></li>
    
      
        <li><a href="/tag/hacktivitycon">Hacktivitycon</a></li>
    
      
        <li><a href="/tag/pwn">Pwn</a></li>
    
      
        <li><a href="/tag/rev">Rev</a></li>
    
      
        <li><a href="/tag/rgbctf">Rgbctf</a></li>
    
      
        <li><a href="/tag/web">Web</a></li>
    
  </ul>


        <article class="article scrollappear">
          <header class="article-header">
            <h1>Granny - Hack The Box</h1>
            <p>Resolution of the Granny machine</p>
            <div class="article-list-footer">
  <span class="article-list-date">
    July 1, 2020
  </span>
  <span class="article-list-divider">-</span>
  <span class="article-list-minutes">
    
    
      4 minute read
    
  </span>
  <span class="article-list-divider">-</span>
  <div class="article-list-tags">
    
      
      <a href="/tag/hackthebox" title="See all posts with tag 'HackTheBox'">HackTheBox</a>
    
  </div>
</div>
          </header>

          <div class="article-content">
            <p><a href="/assets/hackthebox/granny/granny-00-6c3e1b977b29846088be13d14a6e91cb80dbfad49560c32e08d613883c43d1f3.png">
  <img src="/assets/hackthebox/granny/granny-00-6c3e1b977b29846088be13d14a6e91cb80dbfad49560c32e08d613883c43d1f3.png" alt="Granny banner" class="zooming" data-rjs="/assets/hackthebox/granny/granny-00-6c3e1b977b29846088be13d14a6e91cb80dbfad49560c32e08d613883c43d1f3.png" data-zooming-width="598" data-zooming-height="380" />
</a></p>

<p>Granny is an easy level machine based on Windows, the initial approach is based on the famous Microsoft service named <code class="highlighter-rouge">IIS</code>, version 6.0.
The privilege escalation is pretty easy, based on <code class="highlighter-rouge">CVE-2014-4113</code> or <code class="highlighter-rouge">MS14-058</code>.</p>

<h1 id="recon">Recon</h1>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># Nmap 7.80 scan initiated Mon Apr 13 16:38:49 2020 as: nmap -sC -sV -Pn -T4 -oA granny 10.10.10.15</span>
Nmap scan report <span class="k">for </span>10.10.10.15
Host is up <span class="o">(</span>0.15s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 999 filtered ports
PORT   STATE SERVICE VERSION
80/tcp open  http    Microsoft IIS httpd 6.0
| http-methods: 
|_  Potentially risky methods: TRACE DELETE COPY MOVE PROPFIND PROPPATCH SEARCH MKCOL LOCK UNLOCK PUT
| http-ntlm-info: 
|   Target_Name: GRANNY
|   NetBIOS_Domain_Name: GRANNY
|   NetBIOS_Computer_Name: GRANNY
|   DNS_Domain_Name: granny
|   DNS_Computer_Name: granny
|_  Product_Version: 5.2.3790
|_http-server-header: Microsoft-IIS/6.0
|_http-title: Under Construction
| http-webdav-scan: 
|   Server Type: Microsoft-IIS/6.0
|   WebDAV <span class="nb">type</span>: Unknown
|   Server Date: Mon, 13 Apr 2020 19:42:52 GMT
|   Public Options: OPTIONS, TRACE, GET, HEAD, DELETE, PUT, POST, COPY, MOVE, MKCOL, PROPFIND, PROPPATCH, LOCK, UNLOCK, SEARCH
|_  Allowed Methods: OPTIONS, TRACE, GET, HEAD, DELETE, COPY, MOVE, PROPFIND, PROPPATCH, SEARCH, MKCOL, LOCK, UNLOCK
Service Info: OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
<span class="c"># Nmap done at Mon Apr 13 16:39:14 2020 -- 1 IP address (1 host up) scanned in 24.48 seconds</span></code></pre></figure>

<p>Accessing the port 80 we noticed that the server is running a <code class="highlighter-rouge">Microsoft IIS</code> service.</p>

<p>Running the gobuster tool returned nothing really interesting:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="o">===============================================================</span>
Gobuster v3.0.1
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@_FireFart_<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:            http://10.10.10.15
<span class="o">[</span>+] Threads:        20
<span class="o">[</span>+] Wordlist:       /usr/share/wordlists/dirb/big.txt
<span class="o">[</span>+] Status codes:   200,204,301,302,307,401,403
<span class="o">[</span>+] User Agent:     gobuster/3.0.1
<span class="o">[</span>+] Timeout:        10s
<span class="o">===============================================================</span>
2020/04/13 16:39:20 Starting gobuster
<span class="o">===============================================================</span>
/Images <span class="o">(</span>Status: 301<span class="o">)</span>
/_private <span class="o">(</span>Status: 301<span class="o">)</span>
/_vti_bin <span class="o">(</span>Status: 301<span class="o">)</span>
/_vti_log <span class="o">(</span>Status: 301<span class="o">)</span>
/aspnet_client <span class="o">(</span>Status: 301<span class="o">)</span>
/images <span class="o">(</span>Status: 301<span class="o">)</span>
<span class="o">===============================================================</span>
2020/04/13 16:42:05 Finished
<span class="o">===============================================================</span></code></pre></figure>

<p>After searching for any suitable exploit for <code class="highlighter-rouge">IIS 6.0</code> we found the following exploit:</p>

<p><a href="https://www.rapid7.com/db/modules/exploit/windows/iis/iis_webdav_scstoragepathfromurl" target="_blank">Microsoft IIS WebDav ScStoragePathFromUrl Overflow</a></p>

<p>This Metasploit module is based on the <code class="highlighter-rouge">CVE 2017-7269</code> that exploits a vulnerability present in the IIS module named <code class="highlighter-rouge">ScStoragePathFromUrl</code> through 3 ROP’s.</p>

<h1 id="exploiting---using-a-metasploit-module">Exploiting - Using a Metasploit module</h1>

<p>Metasploit has a module for this exploit named <code class="highlighter-rouge">iis_webdav_scstoragepathfromurl</code> and it’s pretty easy to get a reverse shell connection:</p>

<p><a href="/assets/hackthebox/granny/granny-01-2e81f0a0b16c6bb052447982478a0725dba7de86b3908339b81703c1dd90c33e.png">
  <img src="/assets/hackthebox/granny/granny-01-2e81f0a0b16c6bb052447982478a0725dba7de86b3908339b81703c1dd90c33e.png" alt="Granny Exploit" class="zooming" data-rjs="/assets/hackthebox/granny/granny-01-2e81f0a0b16c6bb052447982478a0725dba7de86b3908339b81703c1dd90c33e.png" data-zooming-width="739" data-zooming-height="404" />
</a></p>

<h1 id="exploiting---using-a-custom-exploit">Exploiting - Using a custom exploit</h1>

<p>For knowledge purposes I made a custom exploit that exploit this IIS vulnerability and spawn an interactive shell to us, it’s available on my GitHub :)</p>

<p><a href="https://github.com/nullarmor/hackthebox-exploits/tree/master/granny" target="_blank">Granny Exploit</a></p>

<p><a href="/assets/hackthebox/granny/granny-02-bb6cd5af4bc61422ee79118cee69cba18feafd9a61ee6fbcfaab9a8fe932db5e.png">
  <img src="/assets/hackthebox/granny/granny-02-bb6cd5af4bc61422ee79118cee69cba18feafd9a61ee6fbcfaab9a8fe932db5e.png" alt="Granny Exploit" class="zooming" data-rjs="/assets/hackthebox/granny/granny-02-bb6cd5af4bc61422ee79118cee69cba18feafd9a61ee6fbcfaab9a8fe932db5e.png" data-zooming-width="640" data-zooming-height="290" />
</a></p>

<blockquote>
  <p>This exploit has a problem: the reverse shell connection drops after some minutes, maybe because of the machine configs.</p>
</blockquote>

<h1 id="post-exploitation---migrating-process-and-escalating-privileges-with-ms14-058">Post Exploitation - Migrating process and escalating privileges with MS14-058</h1>

<p>After the initial exploit, we need to escalate our privileges in order to read both flags because our current user has no privileges.
After executing the <code class="highlighter-rouge">local privilege escalation</code> module from Metasploit, we found a suitable exploit named <code class="highlighter-rouge">MS14-058</code>:</p>

<p><a href="https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-058" target="_blank">MS14-058</a></p>

<p>There’s a Metasploit version of this exploit: <a href="https://www.rapid7.com/db/modules/exploit/windows/local/ms14_058_track_popup_menu" target="_blank">Windows TrackPopupMenu Win32k NULL Pointer Dereference </a></p>

<p>The Metasploit module is located at <code class="highlighter-rouge">windows/local/ms14_058_track_popup_menu</code></p>

<p>Before we start, we need to migrate the first meterpreter session process to another one because if we don’t migrate an error will be displayed:</p>

<p><a href="/assets/hackthebox/granny/granny-03-b4ca5bb730e55cafc9cd75d3ede33f33e8186f18e2dfd5a807ec0f9805f8fbbb.png">
  <img src="/assets/hackthebox/granny/granny-03-b4ca5bb730e55cafc9cd75d3ede33f33e8186f18e2dfd5a807ec0f9805f8fbbb.png" alt="Granny Post Exploitation" class="zooming" data-rjs="/assets/hackthebox/granny/granny-03-b4ca5bb730e55cafc9cd75d3ede33f33e8186f18e2dfd5a807ec0f9805f8fbbb.png" data-zooming-width="835" data-zooming-height="79" />
</a></p>

<p>To migrate the process, we need to list all process using the meterpreter command <code class="highlighter-rouge">ps</code>:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">Process List
<span class="o">============</span>

 PID   PPID  Name               Arch  Session  User                          Path
 <span class="nt">---</span>   <span class="nt">----</span>  <span class="nt">----</span>               <span class="nt">----</span>  <span class="nt">-------</span>  <span class="nt">----</span>                          <span class="nt">----</span>
 0     0     <span class="o">[</span>System Process]                                                
 4     0     System                                                          
 212   1088  cidaemon.exe                                                    
 272   4     smss.exe                                                        
 300   1088  cidaemon.exe                                                    
 324   272   csrss.exe                                                       
 348   272   winlogon.exe                                                    
 396   348   services.exe                                                    
 408   348   lsass.exe                                                       
 620   396   svchost.exe                                                     
 684   396   svchost.exe                                                     
 740   396   svchost.exe                                                     
 772   396   svchost.exe                                                     
 804   396   svchost.exe                                                     
 940   396   spoolsv.exe                                                     
 968   396   msdtc.exe                                                       
 1088  396   cisvc.exe                                                       
 1136  396   svchost.exe                                                     
 1184  396   inetinfo.exe                                                    
 1220  396   svchost.exe                                                     
 1332  396   VGAuthService.exe                                               
 1412  396   vmtoolsd.exe                                                    
 1460  396   svchost.exe                                                     
 1600  396   svchost.exe                                                     
 1716  396   alg.exe                                                         
 1816  620   wmiprvse.exe       x86   0        NT AUTHORITY<span class="se">\N</span>ETWORK SERVICE  C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32<span class="se">\w</span>bem<span class="se">\w</span>miprvse.exe
 1908  396   dllhost.exe                                                     
 2188  2428  rundll32.exe       x86   0                                      C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32<span class="se">\r</span>undll32.exe
 2324  348   logon.scr                                                       
 2428  1460  w3wp.exe           x86   0        NT AUTHORITY<span class="se">\N</span>ETWORK SERVICE  c:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv<span class="se">\w</span>3wp.exe
 2468  620   wmiprvse.exe                                                    
 2532  620   davcdata.exe       x86   0        NT AUTHORITY<span class="se">\N</span>ETWORK SERVICE  C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv<span class="se">\d</span>avcdata.exe</code></pre></figure>

<p>I choose the process number 1816 (wmiprvse.exe).</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">migrate 1816</code></pre></figure>

<p>After that our process is finally migrated to another one and we’re able to run the exploit with success!</p>

<p><a href="/assets/hackthebox/granny/granny-04-842eccc9b2a7aa52dd91e41778351ef2675d74424c586651bea39eabbd9e5e2f.png">
  <img src="/assets/hackthebox/granny/granny-04-842eccc9b2a7aa52dd91e41778351ef2675d74424c586651bea39eabbd9e5e2f.png" alt="Granny Post Exploitation" class="zooming" data-rjs="/assets/hackthebox/granny/granny-04-842eccc9b2a7aa52dd91e41778351ef2675d74424c586651bea39eabbd9e5e2f.png" data-zooming-width="729" data-zooming-height="191" />
</a></p>

<p>Done, now we’re <code class="highlighter-rouge">NT AUTHORITY\SYSTEM</code> and able to read both flags!</p>

<p><a href="/assets/hackthebox/granny/granny-05-4897609b1644f844708f2fabaeb36df00badca0c3eb23ba09d162c40cbd103d1.png">
  <img src="/assets/hackthebox/granny/granny-05-4897609b1644f844708f2fabaeb36df00badca0c3eb23ba09d162c40cbd103d1.png" alt="Granny Post Exploitation" class="zooming" data-rjs="/assets/hackthebox/granny/granny-05-4897609b1644f844708f2fabaeb36df00badca0c3eb23ba09d162c40cbd103d1.png" data-zooming-width="405" data-zooming-height="172" />
</a></p>

<p><a href="/assets/hackthebox/granny/granny-06-9b40486355236fe9379f9137f3ca3353280d2edc542fee8f6c0209a6b37bedae.png">
  <img src="/assets/hackthebox/granny/granny-06-9b40486355236fe9379f9137f3ca3353280d2edc542fee8f6c0209a6b37bedae.png" alt="Granny Post Exploitation" class="zooming" data-rjs="/assets/hackthebox/granny/granny-06-9b40486355236fe9379f9137f3ca3353280d2edc542fee8f6c0209a6b37bedae.png" data-zooming-width="1049" data-zooming-height="83" />
</a></p>

          </div>
          <div class="article-share">
            
            
            <a href="https://twitter.com/home?status=Granny+-+Hack+The+Box%20-%20https://nullarmor.github.io/posts/granny%20by%20@nullarmor" title="Share on Twitter" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M492 109.5c-17.4 7.7-36 12.9-55.6 15.3 20-12 35.4-31 42.6-53.6 -18.7 11.1-39.4 19.2-61.5 23.5C399.8 75.8 374.6 64 346.8 64c-53.5 0-96.8 43.4-96.8 96.9 0 7.6 0.8 15 2.5 22.1 -80.5-4-151.9-42.6-199.6-101.3 -8.3 14.3-13.1 31-13.1 48.7 0 33.6 17.2 63.3 43.2 80.7C67 210.7 52 206.3 39 199c0 0.4 0 0.8 0 1.2 0 47 33.4 86.1 77.7 95 -8.1 2.2-16.7 3.4-25.5 3.4 -6.2 0-12.3-0.6-18.2-1.8 12.3 38.5 48.1 66.5 90.5 67.3 -33.1 26-74.9 41.5-120.3 41.5 -7.8 0-15.5-0.5-23.1-1.4C62.8 432 113.7 448 168.3 448 346.6 448 444 300.3 444 172.2c0-4.2-0.1-8.4-0.3-12.5C462.6 146 479 129 492 109.5z"/></svg>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=https://nullarmor.github.io/posts/granny" title="Share on Facebook" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M288 192v-38.1c0-17.2 3.8-25.9 30.5-25.9H352V64h-55.9c-68.5 0-91.1 31.4-91.1 85.3V192h-45v64h45v192h83V256h56.4l7.6-64H288z"/></svg>
            </a>
          </div>

          
            <div id="disqus_thread" class="article-comments"></div>
            <script src="https://nullarmor.disqus.com/embed.js" async defer></script>
            <noscript>Please enable JavaScript to view the comments.</noscript>
          
        </article>
        <footer class="footer scrollappear">
  <p>
    This site uses Chalk theme made by Nielsen Ramon.
  </p>
</footer>

      </div>
    </div>
  </main>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-159304176-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-159304176-1');
  </script>


<script type="text/javascript" src="/assets/vendor-2c224c53eb697c739f9490c38819a72184f09472739fd9e492272ef174090428.js"></script>


  <script type="text/javascript" src="/assets/webfonts-96493456d319d1bf419afdf8701552d4d486fee6afd304897d4fd81eb4e0cc0b.js"></script>



  <script type="text/javascript" src="/assets/scrollappear-e2da8ea567e418637e31266cc5302126eaa79f62a2273739086358b589a89ee6.js"></script>


<script type="text/javascript" src="/assets/application-cfde13ac81ddaf4351b2e739603e2baf688d0fcc9aba613fe62bbb1c7b037fb9.js"></script>


  <script type="text/javascript" src="/assets/themetoggle-df0d3d73164dc26dffbd630182ae4d0dfa7bee6b694a2b5d565d73595b582bbf.js"></script>

</body>
</html>
